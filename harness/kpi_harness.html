<!DOCTYPE html>
<html>

<head>
    <title>KPI Canvas Harness</title>
    <style>
        body,
        html {
            height: 100%;
            margin: 0;
            font-family: sans-serif;
        }

        #vis-container {
            height: 80vh;
            border: 1px solid #ccc;
            margin: 20px;
        }

        #controls {
            padding: 20px;
            background: #f0f0f0;
            display: flex;
            gap: 10px;
        }
    </style>
</head>

<body>
    <div id="controls">
        <button onclick="renderCanvas()">Reload Canvas</button>
        <label><input type="checkbox" id="edit-mode-toggle" onchange="toggleEditMode()"> Edit Mode</label>
    </div>

    <div id="vis-container"></div>

    <!-- Mocks -->
    <script>
        // Mock Looker Object
        window.looker = {
            plugins: {
                visualizations: {
                    add: function (viz) {
                        // Mock standard Looker Viz methods
                        viz.clearErrors = function () { console.log("clearErrors called"); };
                        viz.addError = function (e) { console.error("addError:", e); };

                        window.registeredViz = viz;
                        console.log("Registered Viz:", viz.id);
                    }
                }
            },
            trigger: function (event, args) {
                console.log("Looker Trigger:", event, args);
                if (event === 'updateConfig') {
                    // Start saving the state
                    const defaults = { ...window.currentConfig };
                    const updates = args[0];
                    window.currentConfig = { ...defaults, ...updates };
                    console.log("Config Updated:", window.currentConfig);
                }
            }
        };

        // Mock Data
        const mockData = [
            {
                "orders.count": { value: 1205, rendered: "1,205" },
                "orders.total_amount": { value: 50200.50, rendered: "$50,200.50" },
                "users.count": { value: 850, rendered: "850" }
            }
        ];

        const mockQueryResponse = {
            fields: {
                dimensions: [],
                measures: [
                    { name: "orders.count", label: "Order Count", is_numeric: true },
                    { name: "orders.total_amount", label: "Total Sales", is_numeric: true },
                    { name: "users.count", label: "Users", is_numeric: true }
                ]
            }
        };

        window.currentConfig = {
            edit_mode: false,
            canvas_layout_state: '{}'
        };

        function renderCanvas() {
            const container = document.getElementById('vis-container');
            const viz = window.registeredViz;

            if (!viz) {
                console.error("No viz registered yet!");
                return;
            }

            // Create if not created (simple check)
            if (!container.hasChildNodes()) {
                viz.create(container, window.currentConfig);
            }

            // Update
            viz.updateAsync(
                mockData,
                container,
                window.currentConfig,
                mockQueryResponse,
                {},
                () => console.log("Render Done")
            );
        }

        function toggleEditMode() {
            const isEdit = document.getElementById('edit-mode-toggle').checked;
            window.currentConfig.edit_mode = isEdit;
            renderCanvas();
        }

        // Auto-render on load after script runs
        window.onload = function () {
            setTimeout(renderCanvas, 500);
        };
    </script>

    <!-- Load the Viz -->
    <script src="../dist/kpi_canvas.js"></script>
</body>

</html>